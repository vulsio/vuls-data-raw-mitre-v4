{
	"name": "CVE-2023-52759",
	"seq": "2023-52759",
	"type": "CAN",
	"status": "Candidate",
	"phase": {
		"text": "Assigned",
		"date": "20240521"
	},
	"desc": "In the Linux kernel, the following vulnerability has been resolved: gfs2: ignore negated quota changes When lots of quota changes are made, there may be cases in which an inode's quota information is increased and then decreased, such as when blocks are added to a file, then deleted from it. If the timing is right, function do_qc can add pending quota changes to a transaction, then later, another call to do_qc can negate those changes, resulting in a net gain of 0. The quota_change information is recorded in the qc buffer (and qd element of the inode as well). The buffer is added to the transaction by the first call to do_qc, but a subsequent call changes the value from non-zero back to zero. At that point it's too late to remove the buffer_head from the transaction. Later, when the quota sync code is called, the zero-change qd element is discovered and flagged as an assert warning. If the fs is mounted with errors=panic, the kernel will panic. This is usually seen when files are truncated and the quota changes are negated by punch_hole/truncate which uses gfs2_quota_hold and gfs2_quota_unhold rather than block allocations that use gfs2_quota_lock and gfs2_quota_unlock which automatically do quota sync. This patch solves the problem by adding a check to qd_check_sync such that net-zero quota changes already added to the transaction are no longer deemed necessary to be synced, and skipped. In this case references are taken for the qd and the slot from do_qc so those need to be put. The normal sequence of events for a normal non-zero quota change is as follows: gfs2_quota_change do_qc qd_hold slot_hold Later, when the changes are to be synced: gfs2_quota_sync qd_fish qd_check_sync gets qd ref via lockref_get_not_dead do_sync do_qc(QC_SYNC) qd_put lockref_put_or_lock qd_unlock qd_put lockref_put_or_lock In the net-zero change case, we add a check to qd_check_sync so it puts the qd and slot references acquired in gfs2_quota_change and skip the unneeded sync.",
	"refs": [
		{
			"text": "https://git.kernel.org/stable/c/119565e566f91ff3588ffcd5812f0c8061586c6b",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/119565e566f91ff3588ffcd5812f0c8061586c6b"
		},
		{
			"text": "https://git.kernel.org/stable/c/1c28dace66015b675a343b89b0c87abbfda05ff4",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/1c28dace66015b675a343b89b0c87abbfda05ff4"
		},
		{
			"text": "https://git.kernel.org/stable/c/212f112fe5e90e98eb8d48585682880dae139f4c",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/212f112fe5e90e98eb8d48585682880dae139f4c"
		},
		{
			"text": "https://git.kernel.org/stable/c/2a054b87a1b799b391e578597a42ee6e57a987ae",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/2a054b87a1b799b391e578597a42ee6e57a987ae"
		},
		{
			"text": "https://git.kernel.org/stable/c/2bb42a27a92ff3984c9fa5fbe128eced3ea693f2",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/2bb42a27a92ff3984c9fa5fbe128eced3ea693f2"
		},
		{
			"text": "https://git.kernel.org/stable/c/4c6a08125f2249531ec01783a5f4317d7342add5",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/4c6a08125f2249531ec01783a5f4317d7342add5"
		},
		{
			"text": "https://git.kernel.org/stable/c/53fc16c1ad84f5467ec24341670b63aa759335d3",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/53fc16c1ad84f5467ec24341670b63aa759335d3"
		},
		{
			"text": "https://git.kernel.org/stable/c/5bfda356e903633d16ae1bac1ee38364e12628a3",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/5bfda356e903633d16ae1bac1ee38364e12628a3"
		},
		{
			"text": "https://git.kernel.org/stable/c/b4deec69fe32b58dc5fb4ace52456ece85b75561",
			"source": "MISC",
			"url": "https://git.kernel.org/stable/c/b4deec69fe32b58dc5fb4ace52456ece85b75561"
		}
	],
	"votes": {}
}
